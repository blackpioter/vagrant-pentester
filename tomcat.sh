#! /usr/bin/env bash
# tomcat application user configuration  
# for both wavesep and webgoat
[ -n "$DEBUG" ] && set -x
wget http://mirror.symnds.com/software/Apache/tomcat/tomcat-7/v7.0.53/bin/apache-tomcat-7.0.53.tar.gz
tar -zxvf apache-tomcat-7.0.53.tar.gz
mv apache-tomcat-7.0.29/ /usr/share/tomcat7

sed -i '2i JAVA_HOME="/usr/lib/jvm/java-7-openjdk-i386"' catalina.sh 
sed -i '3i JRE_HOME="/usr/lib/jvm/java-7-openjdk-i386/jre"' catalina.sh
  
sed -i '/<tomcat-users>/a\
  <role rolename="manager"/> \
  <user username="tomcat" password="tomcat" roles="manager"/> \
  <role rolename="webgoat_basic"/> \
  <role rolename="webgoat_admin"/> \
  <role rolename="webgoat_user"/> \
  <role rolename="tomcat"/> \
  <user password="webgoat" roles="webgoat_admin" username="webgoat"/> \
  <user password="basic" roles="webgoat_user,webgoat_basic" username="basic"/> \
  <user password="tomcat" roles="tomcat" username="tomcat"/> \
  <user password="guest" roles="webgoat_user" username="guest"/>' /usr/share/tomcat7/conf/tomcat-users.xml

#create tomcat database
mkdir /usr/share/tomcat7/db
chown vagrant:vagrant /usr/share/tomcat7/db


echo "# Tomcat auto-start
>case $1 in
>start)
>sh /usr/share/tomcat7/bin/startup.sh
>;;
>stop) 
>sh /usr/share/tomcat7/bin/shutdown.sh
>;;
>restart)
>sh /usr/share/tomcat7/bin/shutdown.sh
>sh /usr/share/tomcat7/bin/startup.sh
>;;
>esac 
>exit 0" >> /etc/init.d/tomcat7

chmod 755 /etc/init.d/tomcat7
#create symbolic link to the startup folders
ln -s /etc/init.d/tomcat7 /etc/rc1.d/K99tomcat
ln -s /etc/init.d/tomcat7 /etc/rc2.d/S99tomcat
/etc/init.d/tomcat7 restart